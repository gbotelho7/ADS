<!DOCTYPE html>
<html>
<head>
  <title>Carregamento de CSV com Papa Parse e Tabulator</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.5/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.5/js/tabulator.min.js"></script>
  <script src="https://unpkg.com/mathjs@12.0.0/lib/browser/math.js"></script>
</head>
<body>
  
  <script>
    const storedData = localStorage.getItem('executionData');
    console.log(storedData)
    let jsonData;
    let csvSeparator = storedData.csvSeparator || ';';
    let expectedHeaders = storedData.expectedHeaders || "Curso;Unidade de execução;Turno;Turma;Inscritos no turno;Dia da Semana;Início;Fim;Dia;Características da sala pedida para a aula;Sala da aula;Lotação;Características reais da sala";
    let expectedHeadersArray = expectedHeaders.split(csvSeparator);
    let dynamicCriterium = storedData.dynamicCriterium || "";
    let hourFormat = storedData.hourFormat || "hh/mm/ss";
    let dateFormat = storedData.dateFormat || "dd/mm/aaaa";

  </script>
  <button id="show-form-button">Alterar Configurações Ficheiro</button>
    <form id="hidden-form" style="display: none;">
      <h4>Estas são as definições atuais, pretende alterar alguma?</h4>

      <label for="delimiter">Delimitador:</label>
      <input type="text" id="delimiter" name="delimiter" ><br>

      <label for="hformat">Formato hora:</label>
      <input type="text" id="hformat" name="hformat"><br>

      <label for="dformat">Formato data:</label>
      <input type="text" id="dformat" name="dformat"><br>

      <label for="headers">Cabeçalhos:</label>
      <input type="text" id="headers" name="headers"><br>

      <label for="criterium">Critério Dinâmico:</label>
      <input type="text" id="criterium" name="criterium"><br>

      <input type="submit" value="Submeter">
    </form>
  <br>
  <input type="file" id="csvFileInput" multiple>
  <div id="urlInputs">
    <input type="text" class="urlInput" placeholder="Enter URL">
  </div>
  <button id="parseButton">Submeter URL</button>
  <div id="csvData"></div>
  

  <script>


    document.getElementById('delimiter').placeholder = csvSeparator
    document.getElementById('hformat').placeholder = hourFormat
    document.getElementById('dformat').placeholder = dateFormat
    document.getElementById('headers').placeholder = expectedHeaders
    document.getElementById('criterium').placeholder = dynamicCriterium

    const showFormButton = document.getElementById("show-form-button");
    const parseButton = document.getElementById("parseButton");
    const form = document.getElementById("hidden-form");

    //Permite que o botao desapareca e apareca
    showFormButton.addEventListener("click", () => {
      if (form.style.display === "none") {
        form.style.display = "block";
      } else {
        form.style.display = "none";
      }
    });

    
    document.addEventListener("input", function (event) {
      const urlInputs = document.querySelectorAll('.urlInput');
      const lastInput = urlInputs[urlInputs.length - 1];

      if (event.target === lastInput && lastInput.value.trim() !== '') {
        const newInput = document.createElement("input");
        newInput.type = "text";
        newInput.classList.add("urlInput");
        newInput.placeholder = "Enter URL";
        document.getElementById("urlInputs").appendChild(newInput);
      }
    });


    form.addEventListener("submit", function(event) {
      event.preventDefault(); // Prevent the form from actually submitting

      if(document.getElementById("delimiter").value != ""){
        csvSeparator = document.getElementById("delimiter").value;
        expectedHeadersArray = expectedHeaders.split(csvSeparator);
      }
      if(document.getElementById("headers").value != ""){
        expectedHeaders = document.getElementById("headers").value;
        expectedHeadersArray = expectedHeaders.split(csvSeparator);
      }
      if(document.getElementById("criterium").value != ""){
        dynamicCriterium = document.getElementById("criterium").value;
      }
      if(document.getElementById("hformat").value != ""){
        hourFormat = document.getElementById("hformat").value;
      }
      if(document.getElementById("dformat").value != ""){
        dateFormat = document.getElementById("dformat").value;
      }

      // Debug
      console.log("Delimiter:", csvSeparator);
      console.log("Headers:", expectedHeaders);
      console.log("Criterium:", math.evaluate(dynamicCriterium));
      console.log("Hour Format:", hourFormat);
      console.log("Date Format:", dateFormat);
    });


    function handleParsedData(results, index, csvDataDiv) {
      const headersMatch = expectedHeadersArray.every((header) => results.meta.fields.includes(header.trim()));
      console.log(expectedHeadersArray)
      console.log(results.meta.fields)

      if (headersMatch) {
        const table = document.createElement("div");
        table.setAttribute("id", "csvTable" + index);
        csvDataDiv.appendChild(table);

        new Tabulator("#csvTable" + index, {
          data: results.data,
          layout: "fitData",
          autoColumns: true,
          pagination: "local",
          paginationSize: 7,
        });
      } else {
        alert("As configurações do Ficheiro não correspondem aos esperados. Insira as alterações necessárias. A tabela anterior será eliminada");
      }
    }

    document.getElementById("csvFileInput").addEventListener("change", function (e) {
      const files = e.target.files;
      const csvDataDiv = document.getElementById("csvData");
      csvDataDiv.innerHTML = ""; // Clear previous data

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        e.target.value = "";
        Papa.parse(file, {
          delimiter: csvSeparator,
          header: true,
          complete: function (results) {
            handleParsedData(results, i, csvDataDiv);
          }
        });
      }
      saveSettings(csvSeparator, expectedHeaders, dynamicCriterium, hourFormat, dateFormat)
    });


    parseButton.addEventListener("click", () => {
      const urlInputs = document.querySelectorAll('.urlInput');
      const urls = [];
      const csvDataDiv = document.getElementById("csvData");

      urlInputs.forEach(input => {
        if (input.value.trim() !== '') {
          urls.push(input.value.trim());
        }
      });

      if (urls.length > 0) {
        parseURLs(urls, csvDataDiv);
      }
    });

    function parseURLs(urls, csvDataDiv) {
      csvDataDiv.innerHTML = ""; // Clear previous data

      for (let i = 0; i < urls.length; i++) {
        const url = urls[i];
        //e.target.value = "";
        Papa.parse(url, {
          download: true,
          delimiter: csvSeparator,
          header: true,
          complete: function (results) {
            handleParsedData(results, i, csvDataDiv);
          }
        });
      }
      saveSettings(csvSeparator, expectedHeaders, dynamicCriterium, hourFormat, dateFormat)
    };

    function saveSettings(csvSeparator, expectedHeaders, dynamicCriterium, hourFormat, dateFormat){
      let settings = { "csvSeparator": csvSeparator, "expectedHeaders": expectedHeaders, "dynamicCriterium": dynamicCriterium, "hourFormat": hourFormat, "dateFormat": dateFormat};
      localStorage.setItem('executionData', JSON.stringify(settings)); 
    }
  </script>
</body>
</html>
